#!/bin/bash

#!/bin/bash
help(){
        cat <<EOF 
Usage: ts_network_backup  [OPTION]
Create or restore network backup.

        -h              	prints this message
        -c ticket number 	create network backup
	-r backup directory 	restore network backup. The backup directory should be in the foramt date-ticket_number.
	-d 			Data only. Use of this option is strongly discouraged.
	-u 			Users and data only. Use of this option is discouraged.		
	Use this to create or restore network backups. By default it will attempt to restore users, their data and settings, and the progams installed on the machine. 
EOF
        exit 0
}


# config options
group_file="/home/groups"
password_file="/home/passwords"
shadow_file="/home/shadows"
dkpg_file="/home/dpkg.out"

# source common functions
FUNCTIONS=ts_functions.sh # /path/to../
source $FUNCTIONS


# script specific functions

backup_paswords(){
	cat /etc/passwd| while read line ; do 
		user=$(echo $line | awk -F : '{print $1}')
		user_uid=$(echo $line | awk -F : '{print $3}')
		# if UID >999 then is normal (non-system) user
		if [[ $user_uid -gt 999 ]] ; then
			# unless user is a nobody :)
			if [[ ! $user == "nobody" ]]; then
				# gets lists of groups user belongs to
				echo "$user: $(id $user)" >>$group_file
				echo $line >>$password_file
				# /etc/shadow contains the date of last password
				# change. Having this be older than the install
				# should not be a problem, but noting just in case
				grep -e ^$user: /etc/shadow >>$shadow_file
			fi
		fi
	done
}

restore_passwords(){
	# note that copying files back across is not sufficient 
	# need to extract values form files and added to new copies
	
	# Backup existing files
	isotime=$(date +%Y%m%d%H%M%S)
	cp /etc/passwd /etc/passwd.freegeek_ts_bak.$isotime
	cp /etc/group /etc/group.freegeek_ts_bak.$isotime
	cp /etc/shadow /etc/shadow.freegeek_ts_bak.$isotime

	# read /home/password file
	cat $password_file| while read line ; do
 		user=$(echo $line | awk -F : '{print $1}')
		uid=$(echo $line | awk -F : '{print $3}')
		gid=$(echo $line | awk -F : '{print $4}')
		
                # delete matchinf lines in /etc/passwd 
                sed -i '/^$user:/ d' /etc/passwd
                # delete existing encypted password 
                sed -i '/^$user:/ d' /etc/shadow
		# delete matching lines/existing groups
                sed -i '/:$gid:/ d' /etc/group
		
		#copy relevant lines to /etc/passwd& shadow 
		echo $line >> /etc/passwd
		grep -e '/^$user:/' home/shadow >> /etc/shadow
                # create group for  user
                addgroup --gid $gid $user

		# read /home/group usermod to addusers to groups 	
		groups=$(grep -e '/^$user:/' $group_file | cut -f2- -d, -)
		#number_of_groups=$(echo $groups  | awk -F, '{print NF}')
		IFS=,
		for entry in $groups; do
			group=$(echo $entry | cut -f2 -d'(' - | sed 's/)//')
			usermod -a -G $group $user
		done
	done
}


backup_apt(){
	if  ! dpkg --get-selections > $dpkg_file ; then
		echo 2
	else
		echo 0
	fi 
}

restore_apt(){
        if  ! dpkg --set-selections < $dpkg_file ; then
                exit=2
        else
                exit=0
        fi
	
	echo $exit
}

restore_packages(){
	if  ! apt-get -u dselect-upgrade  ; then
                exit=2
        else
                exit=0
        fi

        echo $exit
}


backup_config(){
       if  ! tar -cvzf /home/etc_backup.tar.gz /etc/; then
                exit=2
        else
                exit=0
        fi

        echo $exit

}

check_log_write(){
	if [[ $1 ]]; then
		log_file=$1
	else
		log_file=/home/backup.log
	fi

	if ! touch $log_file; then
		exit=2
	else
		exit=0
	fi

	echo $exit
}

create_backup(){
	ticket="$1-$(date +%Y%m%d)"

	if [[ $2 ]]; then
		mylogfile=$2
	else
		mylogfile=/home/backup.log
	fi

	if ! rsync -avzh home/ tsbackup@tsbackup:/var/tsbackup/$ticket 2>>$mylogfile; then
	 exit=2
        else
                exit=0
        fi
        echo $exit
}



###TODO###
restore_backup(){
}
### MAIN ###

while getopts ":hc:r:du" option; do
        case $option in
                h) help
                   exit 0
                ;;
                c) create_backup="true"
                   ticket_number=$OPTARG
		;;
		r) restore_backup="true"
                   backup_dir=$OPTARG
		;;
		d) data_only="true"
		;;
		u) users_and_data_only="true"
		;;
                /?) help
                    exit 1
                ;;
        esac
	done

#sanity checks
if [[ $create_backup ]] && [[ $restore_backup ]]; then 
	echo "Only one of the c or r options can be used";
	exit 2
fi

if [[ $create_backup ]] && [[ ! $ticket_number ]]; then 
        echo "You must supply a ticket number with the c option";
        exit 2
fi

if [[ $restore_backup ]] && [[ ! $backup_dir ]]; then
        echo "You must supply a backup directory with the r option";
        exit 2
fi

root_test=$(test_for_root)
if [[ $root_test -ne 0 ]]; then
        echo "Could not proceed!"
        echo "Are you root?"
        exit 2
fi


# create
#rsync -avzh home/ tsbackup@tsbackup:/var/tsbackup/[date-ticketnumber] 2>rsync.out 
#  dpkg --get-selections > dpkg.out 

# restore
#  sudo rsync -avzh  tsbackup@tsbackup:/var/tsbackup/[date-ticketnumber] /home
#dpkg --set-selections < dpkg.out
#apt-get -u dselect-upgrade

