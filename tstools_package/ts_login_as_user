#!/bin/bash

help(){
	cat <<EOF 
	usage ts_login_as_user [OPTION]
	-h		prints this message
	-u [USERNAME]	specify the user whose password will be changed. 
EOF
	exit 0
}

# source common functions
FUNCTIONS=ts_functions.sh # /path/to../
source $FUNCTIONS

### MAIN ###

while getopts ":hu:" option; do
	case $option in 
		h) help
		   exit
		;;
		b) user=$OPTARG

		/?) help
		    exit
		;;
	esac
done

root_test=$(test_for_root)
if [[ $root_test -ne 0 ]]; then
        echo "Could not proceed!"
        echo "are you root?"
        exit 2
fi


password_backup=$(backup_passwords)
if [[ $password_backup -ne 0 ]]; then
        echo "WARNING:Password files could not be backed up! exiting..."
        exit 2
fi

if [[ -z $user ]]; then 
	user=$(choose_username)
fi

uid_test=$(test_for_uid $user)
if [[ -z $uid_test ]]; then
	echo "$user not found! exiting..."
                exit 2
fi


password_reset=$(change_password $user)
if [[ password_reset -ne 0 ]]; then
	echo "WARNING:Password could not be reset, exiting..."
	exit 2
else 
	cat <<EOF
password for $user has been set to freegeek. It will revert to the user's original password next time the machine is rebooted or shutdown.

You may mow exit recovery mode and log in as that user.
EOF
	exit 0
fi
